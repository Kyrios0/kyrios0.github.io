<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon/site.webmanifest">

<link rel="stylesheet" href="/css/tailwind.css">
<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn+SC:300,300italic,400,400italic,500,500italic,700,700italic%7CNoto+Sans+SC:300,300italic,400,400italic,500,500italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,500,500italic,700,700italic&display=swap&subset=latin,latin-ext">

<script src="https://kit.fontawesome.com/b2a94976e7.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.kyrios.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Â§çÁé∞ üêûCVE-2017-16995 Linux Êú¨Âú∞ÊèêÊùÉÊºèÊ¥û">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2017-16995 ÂàÜÊûê &amp; Â§çÁé∞">
<meta property="og:url" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/">
<meta property="og:site_name" content="Kyr1os&#39; Blog">
<meta property="og:description" content="Â§çÁé∞ üêûCVE-2017-16995 Linux Êú¨Âú∞ÊèêÊùÉÊºèÊ¥û">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/tcpdump.png">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/ebpf.png">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/verifier.png">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/core.png">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/patch.png">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/bpf_config.png">
<meta property="og:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/exp.png">
<meta property="article:published_time" content="2020-11-24T17:20:45.000Z">
<meta property="article:modified_time" content="2023-01-10T10:33:30.362Z">
<meta property="article:author" content="Kyr1os">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Reproduce">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.kyrios.cn/2020-cve-2017-16995-repro/img/tcpdump.png">


<link rel="canonical" href="https://blog.kyrios.cn/2020-cve-2017-16995-repro/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blog.kyrios.cn/2020-cve-2017-16995-repro/","path":"2020-cve-2017-16995-repro/","title":"CVE-2017-16995 ÂàÜÊûê & Â§çÁé∞"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CVE-2017-16995 ÂàÜÊûê & Â§çÁé∞ | Kyr1os' Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Kyr1os' Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">May the wind guide your road</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-friends"><a href="/friends/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Friends</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar animated fadeInUp">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bpf-berkeley-packet-filter"><span class="nav-number">2.</span> <span class="nav-text">BPF (Berkeley Packet Filter)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ebpf-extended-bpf"><span class="nav-number">2.1.</span> <span class="nav-text">eBPF (extended BPF)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#verifier"><span class="nav-number">3.</span> <span class="nav-text">Verifier</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vulnerability"><span class="nav-number">4.</span> <span class="nav-text">Vulnerability</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#patch"><span class="nav-number">5.</span> <span class="nav-text">Patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reproducing-environment-for-wsl"><span class="nav-number">6.</span> <span class="nav-text">Reproducing Environment (for
WSL)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit"><span class="nav-number">7.</span> <span class="nav-text">Exploit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reference"><span class="nav-number">8.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#further-reading"><span class="nav-number">9.</span> <span class="nav-text">Further reading</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Kyr1os"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Kyr1os</p>
  <div class="site-description" itemprop="description">Each day is a blessing</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kyrios0" title="GitHub ‚Üí https:&#x2F;&#x2F;github.com&#x2F;kyrios0" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kyr1os@qq.com" title="E-Mail ‚Üí mailto:kyr1os@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://osu.ppy.sh/users/11500292" title="OSU ‚Üí https:&#x2F;&#x2F;osu.ppy.sh&#x2F;users&#x2F;11500292" rel="noopener me" target="_blank"><i class="fa fa-headphones fa-fw"></i>OSU</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.kyrios.cn/2020-cve-2017-16995-repro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Kyr1os">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kyr1os' Blog">
      <meta itemprop="description" content="Each day is a blessing">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="CVE-2017-16995 ÂàÜÊûê & Â§çÁé∞ | Kyr1os' Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE-2017-16995 ÂàÜÊûê & Â§çÁé∞
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-11-25 01:20:45" itemprop="dateCreated datePublished" datetime="2020-11-25T01:20:45+08:00">2020-11-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-01-10 18:33:30" itemprop="dateModified" datetime="2023-01-10T18:33:30+08:00">2023-01-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><hr />
<center>
Â§çÁé∞ <span class="github-emoji" data-alias="beetle" style=""
data-fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f41e.png?v8">üêû</span>CVE-2017-16995
Linux Êú¨Âú∞ÊèêÊùÉÊºèÊ¥û
</center>
<hr />
<h2 id="introduction">Introduction</h2>
<p>Êú¨ÊºèÊ¥û‰∫ßÁîüÁöÑÂéüÂõ†ÊòØ Kernel ÁâàÊú¨ &lt;4.13.9 ÁöÑ eBPF
Ê®°Âùó‰∏≠Â≠òÂú®‰∏ÄÊÆµ‰∏çÊ≠£Á°ÆÁöÑÁ¨¶Âè∑Êâ©Â±ïÈÄªËæëÔºå‰ΩøÂæóÊîªÂáªËÄÖÂèØ‰ª•ÊûÑÈÄ†ËæìÂÖ•ËÆ© verifier
ÁöÑÂÆâÂÖ®Ê£ÄÊü•Â§±Êïà‰ªéËÄåËææÂà∞Êú¨Âú∞ÊèêÊùÉÁöÑÊïàÊûú„ÄÇ</p>
<h2 id="bpf-berkeley-packet-filter">BPF (Berkeley Packet Filter)</h2>
<p>BPF È°æÂêçÊÄù‰πâÊòØ Linux
ÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™ÂåÖËøáÊª§Ê®°Âùó„ÄÇ‰∏æ‰∏™ÁÆÄÂçïÁöÑ‰æãÂ≠êÔºåÊàë‰ª¨ÁÜüÊÇâÁöÑ tcpdump
‰∏≠ËøáÊª§ÊµÅÈáèÂåÖÁöÑÊú¨Ë¥®Â∞±ÊòØË∞ÉÁî®‰∫Ü BPF Ê®°Âùó„ÄÇ</p>
<p>‰∏ãÂõæÊòØ‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑË∞ÉÁî®ÈìæÔºålibpcap
Êî∂Âà∞ÂåÖËøáÊª§ÁöÑË°®ËææÂºèÊØîÂ¶Ç<code>tcp and dst port 7070</code>ÂêéÂ∞ÜÂÖ∂ËΩ¨‰πâ‰∏∫‰º™Êú∫Âô®Á†Å‰º†Áªô
BPF Ê®°ÂùóÔºåBPF ÂÜçÂ∞ÜÂåÖËøáÊª§ÁöÑÁªìÊûúÂæÄ‰∏äËøîÂõûÊúÄÁªàÁªôÂà∞ tcpdump ËæìÂá∫„ÄÇ</p>
<p><img src="img/tcpdump.png" /></p>
<p>ËøôÈáåÁöÑ‰º™Êú∫Âô®Á†ÅÂ§ßÊ¶ÇÊòØËøôÊ†∑ÁöÑ‰∏úË•ø</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -d -i lo tcp and dst port 7070</span><br><span class="line">(000) ldh [12]</span><br><span class="line">(001) jeq #0x86dd jt 2 jf 6 # if ipv6 </span><br><span class="line">(002) ldb [20]</span><br><span class="line">(003) jeq #0x6 jt 4 jf 15 # if tcp</span><br><span class="line">(004) ldh [56]</span><br><span class="line">(005) jeq #0x1b9e jt 14 jf 15 # if dst port == 7070(0x1b9e)</span><br><span class="line">(006) jeq #0x800 jt 7 jf 15 # if ipv4</span><br><span class="line">(007) ldb [23]</span><br><span class="line">(008) jeq #0x6 jt 9 jf 15 # if tcp</span><br><span class="line">(009) ldh [20]</span><br><span class="line">(010) jset #0x1fff jt 15 jf 11 # if IP fragmentation</span><br><span class="line">(011) ldxb 4*([14]&amp;0xf)</span><br><span class="line">(012) ldh [x + 16] # get tcp dest port</span><br><span class="line">(013) jeq #0x1b9e jt 14 jf 15 # if dst port == 7070(0x1b9e)</span><br><span class="line">(014) ret #262144 # valid</span><br><span class="line">(015) ret #0 # invalid</span><br></pre></td></tr></table></figure>
<p>ÊâÄ‰ª•Ëøô‰∏™ BPF
Ê®°ÂùóÂèØ‰ª•ÁêÜËß£‰∏∫‰∏Ä‰∏™ËôöÊãüÊú∫‰∏ÄÊ†∑ÁöÑ‰∏úË•øÔºåÂÖ∂ÂèØ‰ª•ÊâßË°å‰∏Ä‰∫õÁî®Êù•ËøáÊª§ÂåÖÁöÑÂ∞èÁ®ãÂ∫è„ÄÇ</p>
<h3 id="ebpf-extended-bpf">eBPF (extended BPF)</h3>
<p>ÈöèÁùÄÊäÄÊúØÁöÑÂèëÂ±ïÔºåBPF ÈÄêÊ∏êÂçáÁ∫ßÊàê‰∏∫‰∫Ü eBPF Ê®°ÂùóÂπ∂Ê∑ªÂä†Âà∞‰∫ÜÂÜÖÊ†∏
(kernel/bpf) ÂΩì‰∏≠„ÄÇeBPF
ÊîπËøõ‰∫Ü‰∏Ä‰∫õÊé•Âè£ËÆæËÆ°ÂíåÊòìÁî®ÊÄßÁöÑ‰∏úË•øÔºå‰ΩøÂÖ∂ËÉΩÂú®ÂÜÖÊ†∏ÁöÑÊõ¥Â§öÂú∫ÊôØ‰∏≠ÂèëÊå•‰ΩúÁî®„ÄÇ</p>
<p>ÂçáÁ∫ßÂêéÁöÑ eBPF ÁöÑÊû∂ÊûÑÂ§ßÊ¶ÇÂ¶Ç‰∏ãÂõæÊâÄÁ§∫</p>
<p><img src="img/ebpf.png" /></p>
<p>Áî®Êà∑ÂèØ‰ª•Â∞ÜËá™Â∑±ÂáÜÂ§áÁöÑ BPF Program Êèê‰∫§Âà∞ eBPF Ê®°ÂùóÔºåÈÄöËøá Verifier
ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÂêéÔºåËøô‰∏™ BPF Program
Â∞ÜÂèØ‰ª•Ë¢´‰ª•ÂÜÖÊ†∏ÊÄÅÊâßË°å„ÄÇÂú®Ëøô‰∏™ËøáÁ®ã‰∏≠ÔºåÁî®Êà∑ÂèØ‰ª•ÈÄöËøá‰∏ÄÂùóÂè´ Map
ÁöÑÂÖ±‰∫´ÂÜÖÂ≠ò‰∏éBPFÈÄö‰ø°„ÄÇ‰∏ãÈù¢ÊòØ‰∏Ä‰∫õÁõ∏ÂÖ≥ÁöÑÁ≥ªÁªüË∞ÉÁî®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, sizeof(attr))</span><br><span class="line">syscall(__NR_bpf, BPF_MAP_LOOKUP_ELEM, &amp;attr, sizeof(attr))</span><br><span class="line">syscall(__NR_bpf, BPF_MAP_UPDATE_ELEM, &amp;attr, sizeof(attr))</span><br><span class="line">syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, sizeof(attr))</span><br><span class="line">setsockopt(sockets[1], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, sizeof(progfd))</span><br></pre></td></tr></table></figure>
<h2 id="verifier">Verifier</h2>
<p>ÁªèËøáÂâçÈù¢ÁöÑÊèèËø∞Êàë‰ª¨ÂèØ‰ª•ËÆ§ËØÜÂà∞ÔºåÂ¶ÇÊûú eBPF Ê®°ÂùóÊ≤°Êúâ
VerifierÔºåÈÇ£‰πàËøô‰ºöÊòØ‰∏Ä‰∏™ÈùûÂ∏∏Âç±Èô©ÁöÑÊ®°ÂùóÂõ†‰∏∫Áî®Êà∑ÂèØ‰ª•Áõ¥Êé•ÈÄöËøáÂÆÉÂú®ÂÜÖÊ†∏ÊÄÅÊâßË°å‰ªªÊÑè‰ª£Á†Å„ÄÇÊâÄ‰ª•ËøôÈáåÁöÑÂÆâÂÖ®Ê£ÄÊü•Â∞±ÊòæÂæóËá≥ÂÖ≥ÈáçË¶Å‰∫Ü„ÄÇVerifier
‰ºöÂú® BPF Program ÊâßË°åÂâçÂØπÂÖ∂ÂÅöËØ¶ÁªÜÁöÑÊ£ÄÊü•ÔºåBPF Program
Â¶ÇÊûúÊ£ÄÊü•‰∏çÈÄöËøá‰ºöË¢´Áõ¥Êé•ÊãíÁªùÔºåÂê¶ÂàôÂ∞±‰ºöÂä†ËΩΩÂà∞<code>__bpf_prog_run</code>ÂáΩÊï∞‰∏≠ÊâßË°å„ÄÇ</p>
<p>Verifier ÁöÑÊ£ÄÊü•ÂàÜ‰∏∫‰∏§‰∏™ÈÉ®ÂàÜ„ÄÇ</p>
<p>Á¨¨‰∏Ä‰∏™ÈÉ®ÂàÜÁöÑÊ£ÄÊü•‰∏ªË¶ÅÊòØÁ°Æ‰øù BPF Program
Ë∂≥Â§üÁÆÄÂçïÔºåËøôÊ†∑ÊâçËÉΩÂú®ÊúâÈôêÁöÑÊó∂Èó¥ÂÜÖÂØπÂÖ∂ËøõË°åÂΩªÂ∫ïÁöÑÂàÜÊûêÔºåËøô‰∏ÄÈÉ®ÂàÜÁöÑÊ£ÄÊü•‰∏ªË¶ÅË¶ÅÊ±ÇË¢´ÊµãÁ®ãÂ∫è</p>
<ul>
<li>Êåá‰ª§Êï∞Èáè‰∏çËÉΩËøáÂ§ö</li>
<li>‰∏çËÉΩÂ≠òÂú®Âæ™ÁéØ</li>
<li>Âè™ËÉΩÊúâ‰∏Ä‰∏™ÂáΩÊï∞</li>
<li>‰∏çËÉΩÊúâË∂äÁïåË∑≥ËΩ¨</li>
</ul>
<p>ÈÄöËøáÁ¨¨‰∏Ä‰∏™Ê£ÄÊü•ÁöÑÁ®ãÂ∫è‰ºöËøõÂÖ•Âà∞Á¨¨‰∫åÈÉ®ÂàÜÁöÑËØ¶ÁªÜÊ£ÄÊü•ÔºåËøôÈáå Verifier ‰ºöÂØπ
BPF Program ÁöÑÊâÄÊúâË∑ØÂæÑÂÅöÂàÜÊûêÂπ∂Ê®°ÊãüÊâßË°åÔºåËøôÈáå‰∏ªË¶ÅÂÖ≥Ê≥®‰∏§‰∏™ÂáΩÊï∞</p>
<ul>
<li><code>check_reg_arg</code></li>
<li><code>check_mem_access</code></li>
</ul>
<p>Ëøô‰∏§‰∏™ÂáΩÊï∞ÁöÑ‰ΩúÁî®Â∞±ÊòØÊ£ÄÊü•ÂØÑÂ≠òÂô®ÂèÇÊï∞ÊòØÂê¶ÂêàÊ≥ï‰ª•ÂèäÂÜÖÂ≠òËÆøÈóÆÊòØÂê¶Âú®Ê≤ôÁÆ±ËåÉÂõ¥ÂÜÖ„ÄÇ</p>
<p>Áî±‰∫é‰∏çÊÉ≥ÂÜôÂ§™ÈïøÂâçÈù¢ÂæàÂ§ö‰∏úË•øÊ≤°ÊúâÁªÜËÆ≤ÔºåÊúâÂÖ¥Ë∂£ËØ¶ÁªÜ‰∫ÜËß£ÁöÑÈÄâÊâãÂèØ‰ª•ÁøªÈòÖ:</p>
<p><a
target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.4.110/source/kernel/bpf/verifier.c">kernel/bpf/verifier.c</a></p>
<p><a
target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.4.110/source/kernel/bpf/core.c">kernel/bpf/core.c</a></p>
<h2 id="vulnerability">Vulnerability</h2>
<p>Âà∞ËøôÈáåËøô‰∏™ Verifier
ÁúãËµ∑Êù•Â∞±ÂæàÂÆâÂÖ®‰∫ÜÔºå‰ΩÜÊòØÂÆûÈôÖ‰∏äÊ®°ÊãüÊâßË°åÁöÑËøáÁ®ã‰∏≠ËøòÊòØÂá∫‰∫ÜÈóÆÈ¢ò„ÄÇ</p>
<p><img src="img/verifier.png" /></p>
<p>Áî±‰∏äÂõæÂèØ‰ª•ÁúãÂà∞Âú®Ê®°ÊãüÊâßË°åËøáÁ®ã‰∏≠ÔºåVerifier
Ê®°ÊãüÁöÑÂØÑÂ≠òÂô®Â≠òÁöÑÁ´ãÂç≥Êï∞ÊòØ<code>int</code>Ôºå‰πüÂ∞±ÊòØ<code>s32</code>Á±ªÂûã„ÄÇ</p>
<p><img src="img/core.png" /></p>
<p>‰ΩÜÊòØÂú®ÂÆûÈôÖÊâßË°åÁöÑÂáΩÊï∞<code>__bpf_prog_run</code>ÂΩì‰∏≠ÔºåÂØÑÂ≠òÂô®‰øùÂ≠òÁöÑÂÖ∂ÂÆûÊòØ<code>u64</code>Á±ªÂûãÁöÑÂÄºÔºåËøôÊ†∑Â∞±‰ºöÂºïÂèëÂÆâÂÖ®ÈóÆÈ¢ò„ÄÇ</p>
<p>‰∏ãÈù¢‰ª•‰∏Ä‰∏™‰æãÂ≠êÊù•ËØ¥Êòé„ÄÇ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PROG:</span><br><span class="line">[0]: ALU_MOV_K(0,9,0x0,0xffffffff) // r9 = 0xffffffff</span><br><span class="line">[1]: JMP_JNE_K(0,9,0x2,0xffffffff) // if r9 != 0xffffffff goto [4]</span><br><span class="line">[2]: ALU64_MOV_K(0,0,0x0,0x0) // r0 = 0</span><br><span class="line">[3]: JMP_EXIT(0,0,0x0,0x0) // exit(0)</span><br><span class="line">[4]: ......</span><br></pre></td></tr></table></figure>
<p>Âú®ËøôÊÆµ BPF Program ÂΩì‰∏≠ÔºåÁ¨¨‰∏ÄË°åÂ∞Ü r9
ËµãÂÄº‰∏∫<code>0xffffffff</code>ÔºåÁ¨¨‰∫åË°åÂà§Êñ≠ r9
ÊòØÂê¶Á≠â‰∫é<code>0xffffffff</code>ÔºåÂ¶ÇÊûúÁõ∏Á≠âÔºåÁ®ãÂ∫èÊâßË°å [2], [3]
Âπ∂ÈÄÄÂá∫ÔºåÂê¶ÂàôË∑≥ËΩ¨Âà∞Êåá‰ª§ [4]„ÄÇ</p>
<p>Âú® Verifier Ê®°ÊãüÊâßË°åÂà∞[1]Êó∂ÔºåËøôÈáåÁöÑË∑≥ËΩ¨Êù°‰ª∂ÊòæÁÑ∂‰∏çÊª°Ë∂≥ r9
ÂàöË¢´ËµãÂÄº‰∏∫<code>0xffffffff</code>ÔºåÁªìÊûúÊòæÁÑ∂„ÄÇÊâÄ‰ª• Verifier
ÁªßÁª≠ÂæÄ‰∏ãÊ®°ÊãüÊâßË°å [2], [3]„ÄÇÁî±‰∫é[3]
ÊòØ<code>EXIT</code>ÔºåÊ≠§Êó∂‰πüÊ≤°ÊúâÂà´ÁöÑ‰ª£Á†ÅÂèØËÉΩË¢´ÊâßË°åÔºåÊïÖ Verifier
ËøîÂõûÔºåÂÆâÂÖ®Ê£ÄÊü•ÈÄöËøá„ÄÇ‰ΩÜÊòØÂú®ÂÆûÈôÖÊâßË°åÁöÑÊó∂ÂÄôÂØÑÂ≠òÂô®ÊòØ 64
‰ΩçÔºåÊâÄ‰ª•ËøôÈáåÂÖ∂ÂÆû‰ºöÊ∂âÂèä‰∏Ä‰∏™<strong>s32Âà∞u64</strong>ÁöÑÁ¨¶Âè∑Êâ©Â±ïÔºåC
ËØ≠Ë®ÄÂØπ‰∫éËøôÁßçÁ¨¶Âè∑Êâ©Â±ïÁöÑÂÆûÁé∞ÊòØÂÖàÊâ©Â±ï‰ΩçÊï∞ÂÜçÁ¨¶Âè∑ÂåñÔºåÂç≥<code>(u64)s32Int -&gt; (u64)((s64) s32Int)</code>ÔºåÈôÑ‰∏äËøôÈáå
JNE ÂØπÂ∫îÁöÑÊ±áÁºñ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0xffffffff81173e7f &lt;__bpf_prog_run+2287&gt;    movsxd rdx, dword ptr [rbx + 4]</span><br><span class="line">0xffffffff81173e83 &lt;__bpf_prog_run+2291&gt;    and    eax, 0xf</span><br><span class="line">0xffffffff81173e86 &lt;__bpf_prog_run+2294&gt;    cmp    qword ptr [rbp + rax*8 - 0x278], rdx</span><br></pre></td></tr></table></figure>
<p>ËøôÈáåÁöÑ<code>movsxd</code>Â∞ÜÁ´ãÂç≥Êï∞<code>0xffffffff</code>Á¨¶Âè∑Êâ©Â±ïÂà∞ 64
‰ΩçÂç≥<code>0xffffffffffffffff</code>Ë£ÖÂÖ• rdxÔºåÁÑ∂ÂêéÁî® rdx
ÂéªÂíåË∑≥ËΩ¨Êù°‰ª∂‰∏≠ÁöÑ<code>0xffffffff</code>‰ΩúÊØîËæÉÔºåÂØπ‰∫éÊó†Á¨¶Âè∑Êï∞ËÄåË®ÄÔºå<code>0xffffffffffffffff</code>Âíå<code>0xffffffff</code>ÊòæÁÑ∂ÊòØ‰∏çÁõ∏Á≠âÁöÑ„ÄÇÊâÄ‰ª•ÂÆûÈôÖÊâßË°åÂà∞
JNE ÁöÑÊó∂ÂÄôÔºåË∑≥ËΩ¨Êù°‰ª∂‰∏∫ÁúüÔºåÁ®ãÂ∫è‰ºöÊâßË°åÂà∞Êú™ÁªèËøáÂÆâÂÖ®Ê£ÄÊü•ÁöÑ [4]
‰ª•Âèä‰πãÂêéÁöÑÊåá‰ª§„ÄÇËøôÂ∞±ÊòØÊú¨ÊºèÊ¥ûÁöÑÂéüÁêÜ„ÄÇ</p>
<h2 id="patch">Patch</h2>
<p>Âú®Â§çÁé∞‰πãÂâçÂÖàÁúã‰∏Ä‰∏ãËøô‰∏™ÊºèÊ¥ûÁöÑ <a
target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=95a762e2c8c942780948091f8f2a4f32fce1ac6f">patch</a></p>
<p><img src="img/patch.png" /></p>
<p>ËøôÈáåÂÖ∂ÂÆûÂ∞±ÂØπÊåá‰ª§ÁöÑÊìç‰ΩúÁ±ªÂûã‰∏çÊòØALU64ÁöÑÊó∂ÂÄôÂØπÊåá‰ª§‰∏≠ÁöÑÁ´ãÂç≥Êï∞Âä†‰∫Ü‰∏Ä‰∏™ u32
ÁöÑÂº∫Âà∂Á±ªÂûãËΩ¨Êç¢ÔºåËøôÈáåÂÖ∂ÂÆûÂ∞±ÊòØ‰øÆÊîπ‰∫ÜËøô‰∏™Á¨¶Âè∑Êâ©Â±ïÁöÑÈ°∫Â∫è„ÄÇÊàëÂÅö‰∏Ä‰∏™ÂØπÊØîÂêÑ‰ΩçÂ∞±Â∫îËØ•ÊòéÁôΩ‰∫Ü„ÄÇ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s32 to u64</span><br><span class="line">old (C compiler): s32 -&gt; s64 -&gt; u64</span><br><span class="line">new (this patch): s32 -&gt; u32 -&gt; u64</span><br></pre></td></tr></table></figure>
<h2 id="reproducing-environment-for-wsl">Reproducing Environment (for
WSL)</h2>
<p>‰∏ãËΩΩ<code>4.4.110</code>ÁâàÊú¨ÁöÑ<a
target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.4.110.tar.gz">ÂÜÖÊ†∏‰ª£Á†Å</a></p>
<p>‰øÆÊîπ makefile ‰ΩøÂÖ∂ÊúÄÂ§ßÈ°µÁ©∫Èó¥‰∏∫ 4M„ÄÇ<a
target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/461314/qemu-cannot-boot-locally-built-linux-kernel-anymore">(refer)</a></p>
<p>Âú® menuconfig
ÈáåÈÄâ‰∏ä<code>General Setup -&gt; Enable bpf() system call</code></p>
<p><img src="img/bpf_config.png" /></p>
<p>ÁºñËØë <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make bzImage</span><br></pre></td></tr></table></figure></p>
<p>Áî® busyboxÔºàÊàñËÄÖÂà´ÁöÑ‰∏úË•øÔºâÊâìÂåÖÊûÑÂª∫Êñá‰ª∂Á≥ªÁªü„ÄÇ</p>
<p>ÊúÄÂêéÂáÜÂ§áÂêØÂä®ËÑöÊú¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 512M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd ./rootfs.img \</span><br><span class="line">-append &quot;console=ttyS0 net.ifnames=0 root=/dev/ram rdinit=/sbin/init&quot; \</span><br><span class="line">-cpu qemu64,+smep,+smap \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-gdb tcp::1234 -S \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<h2 id="exploit">Exploit</h2>
<p><a
target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/45010">https://www.exploit-db.com/exploits/45010</a></p>
<p><img src="img/exp.png" /></p>
<h2 id="reference">Reference</h2>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-lo-eBPF-history/index.html">eBPF
ÁÆÄÂè≤</a></li>
<li><a target="_blank" rel="noopener" href="http://p4nda.top/2019/01/18/CVE-2017-16995/">Linux ebpf
Ê®°ÂùóÊï¥Êï∞Êâ©Â±ïÈóÆÈ¢òÂØºËá¥ÊèêÊùÉÊºèÊ¥ûÂàÜÊûê(CVE-2017-16995)</a></li>
<li><a
target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.4.110/source/samples/bpf">bpf
samples</a></li>
</ul>
<h2 id="further-reading">Further reading</h2>
<p>eBPF Âú®Ëøô‰πãÂêéÂèàÁàÜÂá∫Êù•ÁöÑ‰∏çÂ∞ëÊºèÊ¥ûÔºåÂ¶ÇÊûúÊÉ≥‰∫ÜËß£Êñ∞ÁöÑÊºèÊ¥ûÔºåËØ∑ÂèÇËÄÉ</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2020/4/8/cve-2020-8835-linux-kernel-privilege-escalation-via-improper-ebpf-program-verification">CVE-2020-8835</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1391/">CVE-2020-27194</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.graplsecurity.com/post/kernel-pwning-with-ebpf-a-love-story">CVE-2021-3490</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PWN/" rel="tag"><i class="fa fa-tag"></i> PWN</a>
              <a href="/tags/Reproduce/" rel="tag"><i class="fa fa-tag"></i> Reproduce</a>
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
              <a href="/tags/Kernel/" rel="tag"><i class="fa fa-tag"></i> Kernel</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020-b-autumn-banner/" rel="prev" title="ÊüêÁ´ô banner Âú® Firefox ‰∏äÁöÑÊ∏≤Êüì">
                  <i class="fa fa-angle-left"></i> ÊüêÁ´ô banner Âú® Firefox ‰∏äÁöÑÊ∏≤Êüì
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020-cve-2017-7184-repro/" rel="next" title="CVE-2017-7184 ÂàÜÊûê & Â§çÁé∞">
                  CVE-2017-7184 ÂàÜÊûê & Â§çÁé∞ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 ‚Äì 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-keyboard"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Kyr1os</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/kyrios0" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.umd.js" integrity="sha256-+2+qOqR8CKoHh/AsVR9k2qaDBKWjYNC2nozhYmv5j9k=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","mhchem":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"kyrios0","repo":"kyrios0.github.io","client_id":"6cd5e006f4344b4ef21b","client_secret":"ee2b76bf152d51927924c4699df0df26805c9aab","admin_user":"kyrios0","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"4f64d0ae931cc95eaeb3f5196ad02853"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
